@model MigrationService.Models.Lesson
@{
    ViewData["Title"] = "Добавить занятие";
    var courseId = ViewBag.CourseId as int?;
    var courseName = ViewBag.CourseName as string;
}

<h2>Добавить занятие</h2>

@if (courseId.HasValue && !string.IsNullOrEmpty(courseName))
{
    <div class="alert alert-info">
        <strong>Курс:</strong> @courseName 
        <a href="@Url.Action("Details", "Courses", new { id = courseId.Value })" class="btn btn-sm btn-outline-primary ms-2">← Вернуться к курсу</a>
    </div>
}

@if (TempData["Error"] != null)
{
    <div class="alert alert-danger">@TempData["Error"]</div>
}

@using (Html.BeginForm())
{
    @Html.AntiForgeryToken()
    @Html.ValidationSummary(false, "", new { @class = "text-danger" })
    <div class="mb-3">
        @Html.LabelFor(m => m.StudentID, "Курсант")
        @Html.DropDownListFor(m => m.StudentID, (SelectList)ViewBag.Students, "Выберите курсанта...", new { @class = "form-select" })
        @Html.ValidationMessageFor(m => m.StudentID, "", new { @class = "text-danger" })
    </div>
    <div class="mb-3">
        @Html.LabelFor(m => m.InstructorID, "Инструктор")
        @Html.DropDownListFor(m => m.InstructorID, (SelectList)ViewBag.Instructors, "Выберите инструктора...", new { @class = "form-select" })
        @Html.ValidationMessageFor(m => m.InstructorID, "", new { @class = "text-danger" })
    </div>
    <div class="mb-3">
        @Html.LabelFor(m => m.CourseID, "Курс")
        @if (courseId.HasValue)
        {
            @Html.DropDownListFor(m => m.CourseID, (SelectList)ViewBag.Courses, "Выберите курс...", new { @class = "form-select", @disabled = "disabled" })
            @Html.HiddenFor(m => m.CourseID)
            <small class="form-text text-muted">Курс выбран из контекста: <strong>@courseName</strong></small>
        }
        else
        {
            @Html.DropDownListFor(m => m.CourseID, (SelectList)ViewBag.Courses, "Выберите курс...", new { @class = "form-select", id = "CourseID" })
            <small class="form-text text-muted" id="course-autofill-message"></small>
        }
        @Html.ValidationMessageFor(m => m.CourseID, "", new { @class = "text-danger" })
    </div>
    <div class="mb-3">
        @Html.LabelFor(m => m.AircraftID, "Самолет")
        @Html.DropDownListFor(m => m.AircraftID, (SelectList)ViewBag.Aircraft, "Выберите самолет...", new { @class = "form-select" })
        @Html.ValidationMessageFor(m => m.AircraftID, "", new { @class = "text-danger" })
        <small class="form-text text-muted" id="aircraft-availability-message">Список обновляется в соответствии с выбранной датой.</small>
    </div>
    <div class="mb-3">
        @Html.LabelFor(m => m.Date)
        @Html.TextBoxFor(m => m.Date, "{0:yyyy-MM-dd}", new { @class = "form-control", type = "date" })
        @Html.ValidationMessageFor(m => m.Date, "", new { @class = "text-danger" })
    </div>
    <div class="mb-3">
        @Html.LabelFor(m => m.DurationHours)
        @Html.TextBoxFor(m => m.DurationHours, new { @class = "form-control", type = "number", step = "0.1" })
        @Html.ValidationMessageFor(m => m.DurationHours, "", new { @class = "text-danger" })
    </div>
    <div class="mb-3">
        @Html.LabelFor(m => m.Topic)
        @Html.TextBoxFor(m => m.Topic, new { @class = "form-control" })
        @Html.ValidationMessageFor(m => m.Topic, "", new { @class = "text-danger" })
    </div>
    <div class="mb-3">
        @Html.LabelFor(m => m.Status)
        @Html.DropDownListFor(m => m.Status, new SelectList(new[] { "Запланировано", "В процессе", "Завершено", "Одобрено", "Отменено" }), "Выберите статус...", new { @class = "form-select" })
        @Html.ValidationMessageFor(m => m.Status, "", new { @class = "text-danger" })
    </div>
    <div class="mb-3">
        @Html.LabelFor(m => m.Remarks)
        @Html.TextAreaFor(m => m.Remarks, new { @class = "form-control" })
        @Html.ValidationMessageFor(m => m.Remarks, "", new { @class = "text-danger" })
    </div>
    <button type="submit" class="btn btn-primary">Сохранить</button>
    <a class="btn btn-secondary" href="@Url.Action("Index")">Отмена</a>
}

@section Scripts
{
    <script>
        (function () {
            const studentSelect = document.getElementById('StudentID');
            const courseSelect = document.getElementById('CourseID');
            const message = document.getElementById('course-autofill-message');
            const fetchUrl = '@Url.Action("GetCourseForStudent", "Lessons")';
            const aircraftSelect = document.getElementById('AircraftID');
            const dateInput = document.getElementById('Date');
            const aircraftMessage = document.getElementById('aircraft-availability-message');
            const aircraftFetchUrl = '@Url.Action("GetAvailableAircraft", "Lessons")';

            if (studentSelect && courseSelect && !courseSelect.disabled) {
                const defaultMessage = message ? message.textContent : '';

                function showMessage(text, cssClass) {
                    if (!message) return;
                    message.textContent = text || defaultMessage || '';
                    message.classList.remove('text-muted', 'text-success', 'text-warning');
                    message.classList.add(cssClass || 'text-muted');
                }

                function setCourseOption(courseId, courseName) {
                    const option = Array.from(courseSelect.options).find(opt => opt.value === String(courseId));
                    if (option) {
                        courseSelect.value = option.value;
                    } else if (courseId) {
                        const newOption = new Option(courseName || `Курс #${courseId}`, courseId, true, true);
                        newOption.dataset.tempInserted = 'true';
                        courseSelect.add(newOption);
                    }
                    courseSelect.dataset.autofilled = 'true';
                    showMessage(courseName ? `Курс "${courseName}" выбран автоматически.` : 'Курс выбран автоматически.', 'text-success');
                }

                studentSelect.addEventListener('change', function () {
                    const studentId = this.value;
                    if (!studentId) {
                        courseSelect.dataset.autofilled = '';
                        courseSelect.selectedIndex = 0;
                        showMessage('Выберите курс вручную.', 'text-warning');
                        return;
                    }

                    fetch(`${fetchUrl}?studentId=${encodeURIComponent(studentId)}`, {
                        headers: { 'Accept': 'application/json' }
                    })
                        .then(response => response.ok ? response.json() : null)
                        .then(data => {
                            if (!data || !data.hasCourse) {
                                courseSelect.dataset.autofilled = '';
                                courseSelect.selectedIndex = 0;
                                showMessage('У выбранного курсанта нет назначенного курса — выберите его вручную.', 'text-warning');
                                return;
                            }
                            setCourseOption(data.courseId, data.courseName);
                        })
                        .catch(() => {
                            courseSelect.dataset.autofilled = '';
                            showMessage('Не удалось определить курс. Выберите его вручную.', 'text-warning');
                        });
                });

                courseSelect.addEventListener('change', function () {
                    if (this.dataset.autofilled === 'true') {
                        this.dataset.autofilled = '';
                        showMessage('Курс изменен вручную.', 'text-warning');
                    }
                });
            }

            function showAircraftMessage(text, cssClass) {
                if (!aircraftMessage) return;
                aircraftMessage.textContent = text;
                aircraftMessage.className = `form-text ${cssClass || 'text-muted'}`;
            }

            function refreshAircraftList(dateValue) {
                if (!aircraftSelect || !dateValue) return;
                aircraftSelect.disabled = true;
                showAircraftMessage('Проверяем доступные самолеты...', 'text-muted');

                fetch(`${aircraftFetchUrl}?date=${encodeURIComponent(dateValue)}`, { headers: { 'Accept': 'application/json' } })
                    .then(response => response.ok ? response.json() : null)
                    .then(data => {
                        if (!data || data.success !== true) {
                            showAircraftMessage('Не удалось получить данные о самолетах. Список может быть неполным.', 'text-warning');
                            aircraftSelect.disabled = false;
                            return;
                        }

                        const selectedValue = aircraftSelect.value;
                        aircraftSelect.innerHTML = '';
                        const defaultOption = new Option('Выберите самолет...', '', true, false);
                        aircraftSelect.add(defaultOption);

                        data.items.forEach(item => {
                            const option = new Option(item.tailNumber, item.id, false, false);
                            option.dataset.status = item.status;
                            option.dataset.model = item.model;
                            aircraftSelect.add(option);
                        });

                        const stillAvailable = data.items.some(item => String(item.id) === selectedValue);
                        if (stillAvailable) {
                            aircraftSelect.value = selectedValue;
                        }

                        aircraftSelect.disabled = false;

                        if (data.items.length === 0) {
                            showAircraftMessage('На выбранную дату нет доступных самолетов.', 'text-warning');
                        }
                        else {
                            showAircraftMessage(`Доступно самолетов: ${data.items.length}.`, 'text-success');
                        }
                    })
                    .catch(() => {
                        showAircraftMessage('Не удалось получить данные о самолетах. Список может быть неполным.', 'text-warning');
                        aircraftSelect.disabled = false;
                    });
            }

            if (dateInput && aircraftSelect) {
                if (dateInput.value) {
                    refreshAircraftList(dateInput.value);
                }

                dateInput.addEventListener('change', function () {
                    if (this.value) {
                        refreshAircraftList(this.value);
                    }
                });
            }
        })();
    </script>
}


